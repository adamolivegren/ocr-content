<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/tesseract.js@4.0.0/dist/tesseract.min.js"></script>
    <script src="js/getContent.js"></script>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="cropper.css" />
    <script src="cropper.js"></script>
  </head>
  <body>
    <div class="outer-div">
      <div class="logo"><img src="img/11hektar.png" alt="11hektar-logo" /></div>
      <label class="input-button">
        Välj/Ta bild
        <input
          id="image-input"
          style="display: none"
          type="file"
          accept="image/jpeg,image/png"
        />
      </label>
      <div class="img-div">
        <img src="" alt="" />
      </div>
      <div class="crop-button"><p>CROP</p></div>
      <div class="result"></div>
      <div id="loading-indicator">
        <div class="spinner"></div>
      </div>
      <img src="" alt="" id="test" />
      <div class="ocr-button" onclick="runOCR()"><p>Kör OCR</p></div>
      <div class="reset-button" onclick="reset()">
        <p>Starta om</p>
      </div>
    </div>

    <script>
      let img = "img/IMG_2815.jpg";
      let ingredients;
      getData().then((result) => {
        ingredients = result;
      });

      /* REMOVE: used for testing */
      // window.onload = function () {
      //   document.querySelector(".img-div img").src = img;
      //   document.querySelector(".img-div img").style.display = "block";
      //   const cropper = new Cropper(document.querySelector(".img-div img"), {
      //     zoomable: false,
      //   });
      //   document.querySelector(".crop-button").addEventListener("click", () => {
      //     // get the cropped image as a canvas
      //     const canvas = cropper.getCroppedCanvas();
      //     img = canvas.toDataURL();
      //     cropper.destroy();
      //     document.querySelector(".img-div img").src = img;
      //     document.querySelector(".img-div img").style.width = "auto";
      //     document.querySelector(".img-div img").style.height = "auto";
      //   });
      // };

      const input = document.getElementById("image-input");
      input.addEventListener("change", () => {
        const file = input.files[0];
        if (file) {
          const reader = new FileReader();
          reader.addEventListener("load", () => {
            img = reader.result;
            document.querySelector(".img-div img").src = reader.result;
            document.querySelector(".img-div img").style.display = "block";
            const cropper = new Cropper(document.querySelector(".img-div img"));
            document.querySelector(".crop-button").style.display = "flex";
            document.querySelector(".input-button").style.display = "none";
            document
              .querySelector(".crop-button")
              .addEventListener("click", () => {
                // get the cropped image as a canvas
                const canvas = cropper.getCroppedCanvas();
                img = canvas.toDataURL();
                cropper.destroy();
                document.querySelector(".crop-button").style.display = "none";
                document.querySelector(".img-div img").src = img;
                document.querySelector(".img-div img").style.width = "auto";
                document.querySelector(".img-div img").style.height = "auto";
                document.querySelector(".ocr-button").style.display = "flex";
                document.querySelector(".reset-button").style.display = "flex";
              });
          });
          reader.readAsDataURL(file);
        }
      });

      const reset = () => {
        document.querySelector(".result").innerHTML = "";
        document.querySelector(".img-div img").style.display = "none";
        document.querySelector(".reset-button").style.display = "none";
        document.querySelector(".ocr-button").style.display = "none";
        document.querySelector(".input-button").style.display = "flex";
        document.querySelector(".logo").style.marginTop = "0";
      };

      const printResult = (text) => {
        let warning = false;
        const result = document.querySelector(".result");
        const header = document.createElement("h2");
        const headerNode = document.createTextNode(
          "Vi hittade ett par potentiellt skadliga ämnen."
        );
        header.appendChild(headerNode);
        result.appendChild(header);

        ingredients.forEach((e) => {
          if (text.includes(e.Name) && e.Name && e.Grading >= 3) {
            const element = document.createElement("h4");
            const elementNode = document.createTextNode(e.Name);
            element.appendChild(elementNode);
            const para = document.createElement("p");
            if (e.Desc) {
              const paraNode = document.createTextNode(e.Desc);
              para.appendChild(paraNode);
            } else {
              const paraNode = document.createTextNode("Beskrivning saknas.");
              para.appendChild(paraNode);
            }
            document.querySelector(".result").appendChild(element);
            document.querySelector(".result").appendChild(para);

            warning = true;
          }
        });

        let recommendation = "";
        warning
          ? (recommendation = "⛔️ Rekommenderas inte!")
          : (recommendation = "✅ Produkten är OK!");

        const reco = document.createElement("h3");
        const recoNode = document.createTextNode(recommendation);
        reco.appendChild(recoNode);
        document.querySelector(".result").appendChild(reco);
      };

      function showLoadingAnimation() {
        document.getElementById("loading-indicator").style.display = "block";
      }

      function hideLoadingAnimation() {
        document.getElementById("loading-indicator").style.display = "none";
      }

      function runOCR() {
        showLoadingAnimation();
        Tesseract.recognize(img, "eng").then(
          ({ data: { text, hocr, tsv, blocks } }) => {
            hideLoadingAnimation();
            printResult(text);
            document.querySelector(".ocr-button").style.display = "none";
            document.querySelector(".reset-button").style.display = "flex";
            document.querySelector(".outer-div").style.justifyContent =
              "flex-start";
            document.querySelector(".logo").style.marginTop = "5vh";
          }
        );
      }
    </script>
  </body>
</html>
